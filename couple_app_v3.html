<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãµãŸã‚Šã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@300;400;600&family=Cormorant+Garamond:ital,wght@0,300;0,500;1,300&display=swap" rel="stylesheet">
<style>
:root{
  --blush:#f5e6e0;--dusty-rose:#d4908a;--mauve:#9e6b72;
  --deep:#3d2630;--cream:#fdf8f5;--sage:#8fa89a;--gold:#c9a96e;
  --text:#3d2630;--shadow:rgba(61,38,48,0.12);
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Noto Serif JP',serif;background:var(--cream);color:var(--text);min-height:100vh;overflow-x:hidden;}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse at 20% 10%,rgba(212,144,138,.15) 0%,transparent 50%),radial-gradient(ellipse at 80% 80%,rgba(143,168,154,.12) 0%,transparent 50%);pointer-events:none;z-index:0;}

.app-shell{max-width:390px;margin:0 auto;min-height:100vh;position:relative;z-index:1;display:flex;flex-direction:column;}
.status-bar{display:flex;justify-content:space-between;align-items:center;padding:12px 20px 8px;font-size:11px;color:var(--mauve);font-family:'Cormorant Garamond',serif;letter-spacing:.05em;flex-shrink:0;}
.header{padding:8px 24px 16px;text-align:center;flex-shrink:0;}
.couple-badge{display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:4px;}
.avatar{width:32px;height:32px;border-radius:50%;border:2px solid var(--dusty-rose);display:flex;align-items:center;justify-content:center;font-size:14px;background:white;box-shadow:0 2px 8px var(--shadow);}
.heart-divider{font-size:16px;color:var(--dusty-rose);animation:heartbeat 2s ease-in-out infinite;}
@keyframes heartbeat{0%,100%{transform:scale(1)}50%{transform:scale(1.2)}}
.app-title{font-family:'Cormorant Garamond',serif;font-size:26px;font-weight:300;color:var(--deep);letter-spacing:.08em;font-style:italic;}
.app-subtitle{font-size:10px;color:var(--dusty-rose);letter-spacing:.2em;text-transform:uppercase;margin-top:2px;}

.screen{display:none;flex:1;overflow-y:auto;padding-bottom:90px;}
.screen.active{display:block;}

.anniversary-banner{margin:0 16px 16px;background:linear-gradient(135deg,var(--deep) 0%,var(--mauve) 100%);border-radius:16px;padding:14px 18px;display:flex;align-items:center;gap:14px;box-shadow:0 4px 20px rgba(61,38,48,.25);position:relative;overflow:hidden;}
.anniversary-banner::before{content:'â™¡';position:absolute;right:-10px;top:-15px;font-size:80px;color:rgba(255,255,255,.05);pointer-events:none;}
.ann-icon{font-size:28px;flex-shrink:0;}
.ann-text h3{font-family:'Cormorant Garamond',serif;font-size:14px;font-weight:500;color:rgba(255,255,255,.9);letter-spacing:.05em;}
.ann-text p{font-size:11px;color:rgba(255,255,255,.6);margin-top:2px;letter-spacing:.08em;}
.ann-days{margin-left:auto;text-align:center;flex-shrink:0;}
.ann-days .num{font-family:'Cormorant Garamond',serif;font-size:28px;font-weight:300;color:var(--gold);line-height:1;}
.ann-days .label{font-size:9px;color:rgba(255,255,255,.5);letter-spacing:.1em;text-transform:uppercase;}

.section{padding:0 16px;margin-bottom:16px;}
.section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;padding:0 4px;}
.section-title{font-family:'Cormorant Garamond',serif;font-size:18px;font-weight:500;color:var(--deep);letter-spacing:.05em;}
.month-nav{display:flex;align-items:center;gap:8px;}
.nav-btn{width:28px;height:28px;border:1px solid rgba(212,144,138,.4);background:white;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:12px;color:var(--dusty-rose);transition:all .2s;}
.nav-btn:hover{background:var(--dusty-rose);color:white;border-color:var(--dusty-rose);}
.month-label{font-family:'Cormorant Garamond',serif;font-size:14px;color:var(--mauve);letter-spacing:.08em;min-width:80px;text-align:center;}

.calendar-card{background:white;border-radius:20px;padding:16px;box-shadow:0 2px 20px var(--shadow);}
.day-headers{display:grid;grid-template-columns:repeat(7,1fr);margin-bottom:8px;}
.day-header{text-align:center;font-size:10px;color:var(--mauve);letter-spacing:.08em;padding:4px 0;}
.day-header.weekend{color:var(--dusty-rose);}
.calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;}
.cal-day{aspect-ratio:1;display:flex;flex-direction:column;align-items:center;justify-content:center;border-radius:10px;cursor:pointer;transition:all .2s;position:relative;padding:2px;}
.cal-day:not(.empty):hover{background:var(--blush);}
.cal-day.empty{cursor:default;}
.cal-day.today{background:var(--deep);}
.cal-day.today .day-num{color:white;}
.cal-day.selected:not(.today){background:var(--dusty-rose);}
.cal-day.selected:not(.today) .day-num{color:white;}
.cal-day.anniversary:not(.today):not(.selected){background:linear-gradient(135deg,rgba(212,144,138,.15),rgba(201,169,110,.15));border:1px solid rgba(212,144,138,.3);}
.day-num{font-size:13px;font-family:'Cormorant Garamond',serif;font-weight:500;color:var(--text);line-height:1;}
.cal-day.other-month .day-num{color:rgba(61,38,48,.2);}
.cal-day.weekend:not(.today):not(.selected) .day-num{color:var(--dusty-rose);}
.event-dots{display:flex;gap:2px;margin-top:2px;flex-wrap:wrap;justify-content:center;max-width:28px;}
.dot{width:4px;height:4px;border-radius:50%;}
.tap-hint{font-size:10px;color:var(--mauve);opacity:.6;text-align:center;margin-top:8px;letter-spacing:.05em;font-style:italic;}

.events-card{background:white;border-radius:20px;padding:16px;box-shadow:0 2px 20px var(--shadow);}
.events-date-header{font-family:'Cormorant Garamond',serif;font-size:15px;font-style:italic;color:var(--mauve);margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid rgba(212,144,138,.2);display:flex;align-items:center;justify-content:space-between;}
.add-inline-btn{font-size:11px;padding:4px 12px;border-radius:20px;border:1px solid rgba(212,144,138,.4);background:white;color:var(--dusty-rose);cursor:pointer;font-family:'Noto Serif JP',serif;transition:all .2s;}
.add-inline-btn:hover{background:var(--dusty-rose);color:white;}
.event-item{display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid rgba(61,38,48,.05);transition:all .2s;}
.event-item:last-child{border-bottom:none;}
.event-item:hover{transform:translateX(4px);}
.event-color-bar{width:4px;height:40px;border-radius:2px;flex-shrink:0;}
.event-info{flex:1;}
.event-title-text{font-size:13px;font-weight:600;color:var(--deep);margin-bottom:2px;}
.event-meta{font-size:11px;color:var(--mauve);opacity:.7;display:flex;gap:8px;align-items:center;}
.repeat-badge{font-size:9px;padding:1px 6px;border-radius:8px;background:rgba(201,169,110,.15);color:var(--gold);}
.event-who-badge{font-size:11px;padding:3px 8px;border-radius:20px;font-family:'Cormorant Garamond',serif;letter-spacing:.05em;white-space:nowrap;}

.memo-screen-header{padding:16px 16px 8px;display:flex;align-items:center;justify-content:space-between;}
.memo-screen-title{font-family:'Cormorant Garamond',serif;font-size:22px;font-weight:500;color:var(--deep);letter-spacing:.05em;font-style:italic;}
.memo-count{font-size:11px;color:var(--mauve);background:var(--blush);padding:3px 10px;border-radius:20px;}
.memo-input-card{margin:0 16px 16px;background:white;border-radius:20px;padding:16px;box-shadow:0 2px 20px var(--shadow);}
.memo-input-area{width:100%;border:none;outline:none;font-family:'Noto Serif JP',serif;font-size:13px;color:var(--text);resize:none;background:transparent;line-height:1.8;min-height:60px;}
.memo-input-area::placeholder{color:rgba(61,38,48,.3);font-style:italic;}
.memo-input-footer{display:flex;justify-content:space-between;align-items:center;margin-top:8px;padding-top:8px;border-top:1px solid rgba(212,144,138,.2);}
.memo-tags{display:flex;gap:6px;flex-wrap:wrap;}
.memo-tag{font-size:10px;padding:3px 10px;border-radius:20px;border:1px solid rgba(212,144,138,.35);color:var(--dusty-rose);cursor:pointer;transition:all .2s;letter-spacing:.05em;}
.memo-tag:hover,.memo-tag.active{background:var(--dusty-rose);color:white;border-color:var(--dusty-rose);}
.send-btn{width:32px;height:32px;background:var(--deep);border:none;border-radius:50%;color:white;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;transition:all .2s;flex-shrink:0;}
.send-btn:hover{background:var(--dusty-rose);transform:scale(1.1);}

.memo-list{padding:0 16px;display:flex;flex-direction:column;gap:10px;}
.memo-item{background:white;border-radius:16px;padding:14px 16px;box-shadow:0 2px 12px var(--shadow);display:flex;gap:12px;align-items:flex-start;transition:all .2s;}
.memo-item:hover{transform:translateY(-1px);box-shadow:0 4px 20px var(--shadow);}
.memo-item-left{flex:1;}
.memo-item-content{font-size:13px;color:var(--deep);line-height:1.7;margin-bottom:6px;}
.memo-item-footer{display:flex;align-items:center;gap:8px;}
.memo-item-tag{font-size:10px;padding:2px 8px;border-radius:10px;background:var(--blush);color:var(--dusty-rose);}
.memo-item-date{font-size:10px;color:rgba(61,38,48,.35);font-style:italic;}
.memo-delete-btn{width:24px;height:24px;border:none;background:rgba(61,38,48,.06);border-radius:50%;cursor:pointer;color:rgba(61,38,48,.3);font-size:12px;display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0;}
.memo-delete-btn:hover{background:rgba(212,144,138,.2);color:var(--dusty-rose);}
.memo-empty{text-align:center;padding:40px 20px;color:rgba(61,38,48,.3);font-style:italic;font-size:13px;}
.memo-empty-icon{font-size:36px;margin-bottom:8px;}

.bottom-nav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:390px;background:rgba(253,248,245,.96);backdrop-filter:blur(12px);border-top:1px solid rgba(212,144,138,.15);display:flex;justify-content:space-around;padding:10px 0 20px;z-index:150;}
.tab-item{display:flex;flex-direction:column;align-items:center;gap:4px;cursor:pointer;padding:4px 20px;border-radius:12px;transition:all .2s;border:none;background:none;}
.tab-icon{font-size:22px;color:rgba(61,38,48,.25);transition:all .2s;}
.tab-label{font-size:9px;color:rgba(61,38,48,.3);letter-spacing:.1em;text-transform:uppercase;transition:all .2s;}
.tab-item.active .tab-icon{color:var(--dusty-rose);}
.tab-item.active .tab-label{color:var(--dusty-rose);}

.fab{position:fixed;bottom:86px;right:calc(50% - 195px + 16px);width:50px;height:50px;background:linear-gradient(135deg,var(--dusty-rose),var(--mauve));border:none;border-radius:50%;color:white;font-size:22px;cursor:pointer;box-shadow:0 4px 20px rgba(212,144,138,.5);transition:all .3s;display:flex;align-items:center;justify-content:center;z-index:100;}
.fab:hover{transform:scale(1.1) rotate(45deg);}
.fab.hidden{display:none;}

.modal-overlay{position:fixed;inset:0;background:rgba(61,38,48,.5);backdrop-filter:blur(4px);z-index:200;display:none;align-items:flex-end;justify-content:center;}
.modal-overlay.open{display:flex;}
.modal{background:var(--cream);border-radius:24px 24px 0 0;padding:20px 20px 40px;width:100%;max-width:390px;animation:slideUp .3s ease;max-height:92vh;overflow-y:auto;}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal-handle{width:36px;height:4px;background:rgba(61,38,48,.15);border-radius:2px;margin:0 auto 16px;}
.modal-title{font-family:'Cormorant Garamond',serif;font-size:22px;font-weight:500;color:var(--deep);margin-bottom:18px;letter-spacing:.05em;}
.form-group{margin-bottom:14px;}
.form-label{font-size:10px;letter-spacing:.15em;text-transform:uppercase;color:var(--mauve);margin-bottom:6px;display:block;}
.form-input{width:100%;border:1px solid rgba(212,144,138,.3);background:white;border-radius:12px;padding:11px 14px;font-family:'Noto Serif JP',serif;font-size:14px;color:var(--text);outline:none;transition:border-color .2s;}
.form-input:focus{border-color:var(--dusty-rose);}
.who-selector{display:flex;gap:8px;}
.who-btn{flex:1;padding:9px 4px;border:1px solid rgba(212,144,138,.3);background:white;border-radius:12px;cursor:pointer;font-family:'Noto Serif JP',serif;font-size:12px;color:var(--text);transition:all .2s;text-align:center;}
.who-btn.active{background:var(--dusty-rose);color:white;border-color:var(--dusty-rose);}
.color-picker-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
.color-swatch{width:28px;height:28px;border-radius:50%;cursor:pointer;transition:all .2s;border:3px solid transparent;flex-shrink:0;}
.color-swatch.selected{border-color:var(--deep);transform:scale(1.2);}
.color-custom-wrap{position:relative;width:28px;height:28px;flex-shrink:0;}
.color-custom-btn{width:28px;height:28px;border-radius:50%;cursor:pointer;border:2px dashed rgba(61,38,48,.3);background:white;display:flex;align-items:center;justify-content:center;font-size:13px;transition:all .2s;}
.color-custom-btn:hover{border-color:var(--dusty-rose);}
.color-custom-input{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;}
.time-row{display:flex;gap:8px;align-items:center;}
.allday-toggle{padding:9px 14px;border:1px solid rgba(212,144,138,.3);background:white;border-radius:12px;cursor:pointer;font-family:'Noto Serif JP',serif;font-size:12px;color:var(--text);transition:all .2s;white-space:nowrap;}
.allday-toggle.off{background:rgba(212,144,138,.12);border-color:var(--dusty-rose);color:var(--dusty-rose);}
.repeat-row{display:flex;gap:6px;flex-wrap:wrap;}
.repeat-btn{padding:7px 12px;border:1px solid rgba(212,144,138,.3);background:white;border-radius:20px;cursor:pointer;font-family:'Noto Serif JP',serif;font-size:11px;color:var(--text);transition:all .2s;}
.repeat-btn.active{background:var(--gold);color:white;border-color:var(--gold);}
.submit-btn{width:100%;background:linear-gradient(135deg,var(--dusty-rose),var(--mauve));color:white;border:none;border-radius:14px;padding:14px;font-family:'Cormorant Garamond',serif;font-size:16px;letter-spacing:.1em;cursor:pointer;margin-top:6px;transition:all .2s;}
.submit-btn:hover{opacity:.9;transform:translateY(-1px);box-shadow:0 4px 16px rgba(212,144,138,.4);}
.toast{position:fixed;top:60px;left:50%;transform:translateX(-50%) translateY(-20px);background:var(--deep);color:white;padding:10px 20px;border-radius:20px;font-size:12px;letter-spacing:.05em;opacity:0;transition:all .3s;z-index:300;pointer-events:none;white-space:nowrap;}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
</style>
</head>
<body>
<div class="app-shell">
  <div class="status-bar">
    <span id="current-time">9:41</span>
    <span style="font-style:italic;">Calendar</span>
    <span>â—â—â—</span>
  </div>
  <div class="header">
    <div class="couple-badge">
      <div class="avatar">ğŸ§‘</div>
      <div class="heart-divider">â™¡</div>
      <div class="avatar">ğŸ‘©</div>
    </div>
    <div class="app-title">Calendar</div>
    <div class="app-subtitle">äºŒäººã®æ™‚é–“ã‚’ã€ã“ã“ã«</div>
  </div>

  <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç”»é¢ -->
  <div class="screen active" id="screen-calendar">
    <div class="anniversary-banner">
      <div class="ann-icon">ğŸŒ¹</div>
      <div class="ann-text"><h3>è¨˜å¿µæ—¥ã¾ã§ã‚ã¨</h3><p>Anniversary Â· 5æœˆ16æ—¥</p></div>
      <div class="ann-days"><div class="num" id="days-count">0</div><div class="label">days</div></div>
    </div>
    <div class="section">
      <div class="section-header">
        <div class="section-title">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</div>
        <div class="month-nav">
          <button class="nav-btn" id="prev-month">â€¹</button>
          <div class="month-label" id="month-label"></div>
          <button class="nav-btn" id="next-month">â€º</button>
        </div>
      </div>
      <div class="calendar-card">
        <div class="day-headers">
          <div class="day-header weekend">æ—¥</div>
          <div class="day-header">æœˆ</div><div class="day-header">ç«</div>
          <div class="day-header">æ°´</div><div class="day-header">æœ¨</div>
          <div class="day-header">é‡‘</div>
          <div class="day-header weekend">åœŸ</div>
        </div>
        <div class="calendar-grid" id="calendar-grid"></div>
        <div class="tap-hint">âœ¦ æ—¥ä»˜ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨äºˆå®šç¢ºèªï¼†è¿½åŠ ã§ãã¾ã™</div>
      </div>
    </div>
    <div class="section">
      <div class="events-card">
        <div class="events-date-header">
          <span id="events-date-header">ä»Šæ—¥ã®äºˆå®š</span>
          <button class="add-inline-btn" id="add-inline-btn">ï¼‹ è¿½åŠ </button>
        </div>
        <div id="events-list"></div>
      </div>
    </div>
  </div>

  <!-- ãƒ¡ãƒ¢ç”»é¢ -->
  <div class="screen" id="screen-memo">
    <div class="memo-screen-header">
      <div class="memo-screen-title">ãµãŸã‚Šã®ãƒ¡ãƒ¢</div>
      <div class="memo-count" id="memo-count">0ä»¶</div>
    </div>
    <div class="memo-input-card">
      <textarea class="memo-input-area" placeholder="è¡ŒããŸã„å ´æ‰€ã€ã‚„ã‚ŠãŸã„ã“ã¨ã€å½¼å¥³ã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸â€¦" id="memo-text" rows="3"></textarea>
      <div class="memo-input-footer">
        <div class="memo-tags" id="memo-tags">
          <span class="memo-tag">è¡ŒããŸã„å ´æ‰€</span>
          <span class="memo-tag">ã‚„ã‚ŠãŸã„ã“ã¨</span>
          <span class="memo-tag">ã»ã—ã„ã‚‚ã®</span>
          <span class="memo-tag">å¤§äº‹ãªã“ã¨</span>
        </div>
        <button class="send-btn" id="send-memo-btn">â†’</button>
      </div>
    </div>
    <div class="memo-list" id="memo-list"></div>
  </div>
</div>

<button class="fab" id="fab">ï¼‹</button>

<div class="bottom-nav">
  <button class="tab-item active" id="tab-calendar" data-tab="calendar">
    <div class="tab-icon">ğŸ—“</div>
    <div class="tab-label">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</div>
  </button>
  <button class="tab-item" id="tab-memo" data-tab="memo">
    <div class="tab-icon">ğŸ“</div>
    <div class="tab-label">ãƒ¡ãƒ¢</div>
  </button>
</div>

<div class="modal-overlay" id="modal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">æ–°ã—ã„äºˆå®šã‚’è¿½åŠ </div>
    <div class="form-group">
      <label class="form-label">ã‚¿ã‚¤ãƒˆãƒ«</label>
      <input class="form-input" id="ev-title" placeholder="ä¾‹ï¼šæ˜ ç”»ãƒ‡ãƒ¼ãƒˆ ğŸ¬">
    </div>
    <div class="form-group">
      <label class="form-label">æ—¥ä»˜</label>
      <input class="form-input" type="date" id="ev-date">
    </div>
    <div class="form-group">
      <label class="form-label">æ™‚é–“</label>
      <div class="time-row">
        <button class="allday-toggle" id="allday-btn">çµ‚æ—¥</button>
        <input class="form-input" type="time" id="ev-time" style="display:none;flex:1;">
        <input class="form-input" type="time" id="ev-time-end" style="display:none;flex:1;">
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">èª°ã®äºˆå®šï¼Ÿ</label>
      <div class="who-selector">
        <button class="who-btn" data-who="mine">ğŸ§‘ ã‚«ã‚¤ãƒˆ</button>
        <button class="who-btn" data-who="hers">ğŸ‘© ãƒãƒ«ã‚¢</button>
        <button class="who-btn active" data-who="shared">ğŸ’‘ ãµãŸã‚Š</button>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">è‰²ã§åŒºåˆ¥</label>
      <div class="color-picker-row" id="color-picker"></div>
    </div>
    <div class="form-group">
      <label class="form-label">ç¹°ã‚Šè¿”ã—</label>
      <div class="repeat-row">
        <button class="repeat-btn active" data-repeat="none">ãªã—</button>
        <button class="repeat-btn" data-repeat="daily">æ¯æ—¥</button>
        <button class="repeat-btn" data-repeat="weekly">æ¯é€±</button>
        <button class="repeat-btn" data-repeat="monthly">æ¯æœˆ</button>
        <button class="repeat-btn" data-repeat="yearly">æ¯å¹´</button>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
      <input class="form-input" id="ev-note" placeholder="å ´æ‰€ã‚„è©³ç´°ãªã©â€¦">
    </div>
    <button class="submit-btn" id="submit-event-btn">äºˆå®šã‚’è¿½åŠ ã™ã‚‹</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDoqBekJCyHGg8ZgZii8hKUssM2eWygb9M",
  authDomain: "calendar-54edf.firebaseapp.com",
  projectId: "calendar-54edf",
  storageBucket: "calendar-54edf.firebasestorage.app",
  messagingSenderId: "335760209643",
  appId: "1:335760209643:web:5798209686e556eeda70ae"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const PALETTE=['#d4908a','#9e6b72','#8fa89a','#c9a96e','#7b9eb3','#a89ac9','#b5c98a','#e8a87c','#f4b8c8'];
const T=new Date();
const TY=T.getFullYear(),TM=T.getMonth(),TD=T.getDate();

let selColor=PALETTE[3];
let selWho='shared';
let selRepeat='none';
let isAllDay=true;
let curY=TY,curM=TM;
let selDate=null;
let nextId=1;
let events=[];
let memos=[];

// ===== HELPERS =====
function fmtD(y,m,d){
  const dt=new Date(y,m,d);
  return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')}`;
}
function fmtDateLabel(ds){
  const months=['1æœˆ','2æœˆ','3æœˆ','4æœˆ','5æœˆ','6æœˆ','7æœˆ','8æœˆ','9æœˆ','10æœˆ','11æœˆ','12æœˆ'];
  const[y,m,d]=ds.split('-').map(Number);
  return `${y}å¹´${months[m-1]}${d}æ—¥`;
}
function fmtTimeLabel(ds){
  const now=new Date();
  const[y,m,d]=ds.split('-').map(Number);
  const dt=new Date(y,m-1,d);
  const diff=Math.floor((now-dt)/86400000);
  if(diff===0)return 'ä»Šæ—¥';
  if(diff===1)return 'æ˜¨æ—¥';
  if(diff<7)return `${diff}æ—¥å‰`;
  return `${m}/${d}`;
}
function getEventsForDate(ds){
  return events.filter(ev=>{
    if(ev.date===ds)return true;
    if(ev.repeat==='none')return false;
    const[ey,em,ed]=ev.date.split('-').map(Number);
    const[ty,tm,td]=ds.split('-').map(Number);
    if(ev.repeat==='daily')return ds>=ev.date;
    if(ev.repeat==='weekly'){
      const o=new Date(ey,em-1,ed),t2=new Date(ty,tm-1,td);
      const diff=(t2-o)/86400000;
      return diff>=0&&diff%7===0;
    }
    if(ev.repeat==='monthly')return em===tm&&ed===td&&ds>=ev.date;
    if(ev.repeat==='yearly')return em===tm&&ed===td;
    return false;
  });
}
function repeatLabel(r){return{none:'',daily:'æ¯æ—¥',weekly:'æ¯é€±',monthly:'æ¯æœˆ',yearly:'æ¯å¹´'}[r]||'';}
function showToast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg;t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2500);
}

// ===== CLOCK =====
function updateClock(){
  const n=new Date();
  document.getElementById('current-time').textContent=`${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}`;
}
setInterval(updateClock,1000);updateClock();

// ===== ANNIVERSARY =====
function updateCountdown(){
  const now=new Date();
  let next=new Date(now.getFullYear(),4,16);
  if(next<=now)next.setFullYear(next.getFullYear()+1);
  const diff=Math.ceil((next-now)/86400000);
  document.getElementById('days-count').textContent=diff===0?'ä»Šæ—¥ï¼':diff;
}

// ===== CALENDAR =====
function changeMonth(dir){
  curM+=dir;
  if(curM>11){curM=0;curY++;}
  if(curM<0){curM=11;curY--;}
  renderCalendar();
}
function renderCalendar(){
  const months=['1æœˆ','2æœˆ','3æœˆ','4æœˆ','5æœˆ','6æœˆ','7æœˆ','8æœˆ','9æœˆ','10æœˆ','11æœˆ','12æœˆ'];
  document.getElementById('month-label').textContent=`${curY}å¹´ ${months[curM]}`;
  const grid=document.getElementById('calendar-grid');
  grid.innerHTML='';
  const first=new Date(curY,curM,1).getDay();
  const dim=new Date(curY,curM+1,0).getDate();
  const prev=new Date(curY,curM,0).getDate();
  for(let i=first-1;i>=0;i--){grid.appendChild(makeEmpty(prev-i));}
  for(let d=1;d<=dim;d++){
    const ds=fmtD(curY,curM,d);
    const isToday=d===TD&&curM===TM&&curY===TY;
    const isSel=selDate===ds;
    const isWE=[0,6].includes(new Date(curY,curM,d).getDay());
    const isAnn=curM===4&&d===16;
    const evs=getEventsForDate(ds);
    const cell=document.createElement('div');
    let cls='cal-day';
    if(isToday)cls+=' today';
    if(isSel)cls+=' selected';
    if(isWE)cls+=' weekend';
    if(isAnn)cls+=' anniversary';
    cell.className=cls;
    const num=document.createElement('div');
    num.className='day-num';num.textContent=d;cell.appendChild(num);
    if(evs.length){
      const dots=document.createElement('div');dots.className='event-dots';
      evs.slice(0,3).forEach(ev=>{
        const dot=document.createElement('div');dot.className='dot';
        dot.style.background=ev.color||'#d4908a';dots.appendChild(dot);
      });
      cell.appendChild(dots);
    }
    cell.addEventListener('click',()=>selectDate(ds));
    grid.appendChild(cell);
  }
  const total=first+dim;
  const rem=total%7===0?0:7-(total%7);
  for(let d=1;d<=rem;d++)grid.appendChild(makeEmpty(d));
}
function makeEmpty(d){
  const c=document.createElement('div');c.className='cal-day empty other-month';
  const n=document.createElement('div');n.className='day-num';n.textContent=d;c.appendChild(n);return c;
}
function selectDate(ds){
  selDate=ds;
  document.getElementById('ev-date').value=ds;
  renderCalendar();
  renderEvents(ds);
}
function renderEvents(ds){
  const hdr=document.getElementById('events-date-header');
  const list=document.getElementById('events-list');
  const target=ds||fmtD(TY,TM,TD);
  hdr.textContent=ds?fmtDateLabel(ds):'ä»Šæ—¥ã®äºˆå®š';
  const evs=getEventsForDate(target);
  list.innerHTML='';
  if(!evs.length){
    list.innerHTML=`<div style="text-align:center;padding:20px;color:rgba(61,38,48,.3);font-style:italic;font-size:13px;">ã“ã®æ—¥ã¯äºˆå®šãªã— â˜ï¸</div>`;
    return;
  }
  const whoL={mine:'ã‚«ã‚¤ãƒˆ',hers:'ãƒãƒ«ã‚¢',shared:'ãµãŸã‚Š'};
  evs.forEach(ev=>{
    const item=document.createElement('div');item.className='event-item';
    const rl=repeatLabel(ev.repeat);
    item.innerHTML=`
      <div class="event-color-bar" style="background:${ev.color}"></div>
      <div class="event-info">
        <div class="event-title-text">${ev.title}</div>
        <div class="event-meta">
          ${ev.time?`<span>ğŸ• ${ev.time}</span>`:'<span>çµ‚æ—¥</span>'}
          ${rl?`<span class="repeat-badge">ğŸ” ${rl}</span>`:''}
        </div>
      </div>
      <span class="event-who-badge" style="background:${ev.color}22;color:${ev.color}">${whoL[ev.who]||''}</span>
    `;
    list.appendChild(item);
  });
}

// ===== COLOR PICKER =====
function buildColorPicker(){
  const row=document.getElementById('color-picker');row.innerHTML='';
  PALETTE.forEach(c=>{
    const sw=document.createElement('div');
    sw.className='color-swatch'+(c===selColor?' selected':'');
    sw.style.background=c;
    sw.addEventListener('click',()=>{
      selColor=c;
      row.querySelectorAll('.color-swatch').forEach(s=>s.classList.remove('selected'));
      sw.classList.add('selected');
    });
    row.appendChild(sw);
  });
  const wrap=document.createElement('div');wrap.className='color-custom-wrap';
  const btn=document.createElement('div');btn.className='color-custom-btn';btn.textContent='ï¼‹';
  const inp=document.createElement('input');inp.type='color';inp.className='color-custom-input';
  inp.addEventListener('change',()=>{
    selColor=inp.value;
    row.querySelectorAll('.color-swatch').forEach(s=>s.classList.remove('selected'));
    btn.style.background=inp.value;btn.textContent='';
  });
  wrap.appendChild(btn);wrap.appendChild(inp);
  row.appendChild(wrap);
}

// ===== FIREBASE: äºˆå®šè¿½åŠ  =====
async function addEvent(){
  const title=document.getElementById('ev-title').value.trim();
  const date=document.getElementById('ev-date').value;
  if(!title||!date){showToast('ã‚¿ã‚¤ãƒˆãƒ«ã¨æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
  const time=isAllDay?'':(document.getElementById('ev-time').value||'');
  const note=document.getElementById('ev-note').value.trim();
  try{
    await addDoc(collection(db,'events'),{
      date,title,who:selWho,color:selColor,time,note,repeat:selRepeat,createdAt:Date.now()
    });
    document.getElementById('modal').classList.remove('open');
    document.getElementById('ev-title').value='';
    document.getElementById('ev-note').value='';
    const rl=selRepeat!=='none'?`ï¼ˆ${repeatLabel(selRepeat)}ï¼‰`:'';
    showToast(`âœ“ äºˆå®šã‚’è¿½åŠ ã—ã¾ã—ãŸ${rl}`);
  }catch(e){showToast('âŒ ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');console.error(e);}
}

// ===== FIREBASE: ãƒ¡ãƒ¢ =====
async function saveMemo(){
  const text=document.getElementById('memo-text').value.trim();
  if(!text){showToast('ãƒ¡ãƒ¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
  const activeTag=document.querySelector('#memo-tags .memo-tag.active');
  const tag=activeTag?activeTag.textContent:'';
  try{
    await addDoc(collection(db,'memos'),{
      content:text,tag,date:fmtD(TY,TM,TD),createdAt:Date.now()
    });
    document.getElementById('memo-text').value='';
    document.querySelectorAll('#memo-tags .memo-tag.active').forEach(t=>t.classList.remove('active'));
    showToast('ğŸ’Œ ãƒ¡ãƒ¢ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
  }catch(e){showToast('âŒ ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');console.error(e);}
}
async function deleteMemo(id){
  try{await deleteDoc(doc(db,'memos',id));}
  catch(e){showToast('âŒ å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');}
}
function renderMemos(){
  const list=document.getElementById('memo-list');
  const count=document.getElementById('memo-count');
  count.textContent=`${memos.length}ä»¶`;
  list.innerHTML='';
  if(!memos.length){
    list.innerHTML=`<div class="memo-empty"><div class="memo-empty-icon">ğŸ“</div><div>ã¾ã ãƒ¡ãƒ¢ãŒã‚ã‚Šã¾ã›ã‚“</div><div style="margin-top:4px;font-size:11px;">è¡ŒããŸã„å ´æ‰€ã‚„ã‚„ã‚ŠãŸã„ã“ã¨ã‚’æ›¸ã„ã¦ã¿ã‚ˆã†</div></div>`;
    return;
  }
  memos.forEach(m=>{
    const item=document.createElement('div');item.className='memo-item';
    const left=document.createElement('div');left.className='memo-item-left';
    left.innerHTML=`<div class="memo-item-content">${m.content}</div><div class="memo-item-footer">${m.tag?`<span class="memo-item-tag">${m.tag}</span>`:''}<span class="memo-item-date">${fmtTimeLabel(m.date)}</span></div>`;
    const del=document.createElement('button');del.className='memo-delete-btn';del.textContent='âœ•';
    del.addEventListener('click',()=>deleteMemo(m.firestoreId));
    item.appendChild(left);item.appendChild(del);
    list.appendChild(item);
  });
}

// ===== EVENT LISTENERS =====
// æœˆãƒŠãƒ“
document.getElementById('prev-month').addEventListener('click',()=>changeMonth(-1));
document.getElementById('next-month').addEventListener('click',()=>changeMonth(1));

// ã‚¿ãƒ–
document.querySelectorAll('[data-tab]').forEach(btn=>{
  btn.addEventListener('click',()=>{
    const tab=btn.dataset.tab;
    document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
    document.querySelectorAll('.tab-item').forEach(t=>t.classList.remove('active'));
    document.getElementById(`screen-${tab}`).classList.add('active');
    document.getElementById(`tab-${tab}`).classList.add('active');
    document.getElementById('fab').classList.toggle('hidden',tab!=='calendar');
  });
});

// ãƒ¢ãƒ¼ãƒ€ãƒ«
function openModal(){
  document.getElementById('ev-date').value=selDate||fmtD(TY,TM,TD);
  document.getElementById('modal').classList.add('open');
}
document.getElementById('fab').addEventListener('click',openModal);
document.getElementById('add-inline-btn').addEventListener('click',openModal);
document.getElementById('modal').addEventListener('click',e=>{
  if(e.target.id==='modal')document.getElementById('modal').classList.remove('open');
});

// çµ‚æ—¥ãƒˆã‚°ãƒ«
document.getElementById('allday-btn').addEventListener('click',()=>{
  isAllDay=!isAllDay;
  const btn=document.getElementById('allday-btn');
  btn.textContent=isAllDay?'çµ‚æ—¥':'æ™‚é–“ã‚ã‚Š';
  btn.classList.toggle('off',!isAllDay);
  document.getElementById('ev-time').style.display=isAllDay?'none':'block';
  document.getElementById('ev-time-end').style.display=isAllDay?'none':'block';
});

// èª°ã®äºˆå®š
document.querySelectorAll('[data-who]').forEach(btn=>{
  btn.addEventListener('click',()=>{
    selWho=btn.dataset.who;
    document.querySelectorAll('[data-who]').forEach(b=>b.classList.toggle('active',b===btn));
  });
});

// ç¹°ã‚Šè¿”ã—
document.querySelectorAll('[data-repeat]').forEach(btn=>{
  btn.addEventListener('click',()=>{
    selRepeat=btn.dataset.repeat;
    document.querySelectorAll('[data-repeat]').forEach(b=>b.classList.toggle('active',b===btn));
  });
});

// äºˆå®šè¿½åŠ ãƒ»ãƒ¡ãƒ¢
document.getElementById('submit-event-btn').addEventListener('click',addEvent);
document.getElementById('send-memo-btn').addEventListener('click',saveMemo);

// ãƒ¡ãƒ¢ã‚¿ã‚°
document.querySelectorAll('#memo-tags .memo-tag').forEach(tag=>{
  tag.addEventListener('click',()=>tag.classList.toggle('active'));
});

// ===== INIT =====
buildColorPicker();
updateCountdown();
renderCalendar();
renderEvents(null);

// Firebaseãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸ
onSnapshot(query(collection(db,'events'),orderBy('createdAt','asc')),snap=>{
  events=snap.docs.map(d=>({...d.data(),firestoreId:d.id}));
  renderCalendar();
  renderEvents(selDate);
});
onSnapshot(query(collection(db,'memos'),orderBy('createdAt','desc')),snap=>{
  memos=snap.docs.map(d=>({...d.data(),firestoreId:d.id}));
  renderMemos();
});
</script>
</body>
</html>
