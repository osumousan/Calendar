<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãµãŸã‚Šã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@300;400;600&family=Cormorant+Garamond:ital,wght@0,300;0,500;1,300&display=swap" rel="stylesheet">
<style>
  :root {
    --blush:#f5e6e0; --dusty-rose:#d4908a; --mauve:#9e6b72;
    --deep:#3d2630; --cream:#fdf8f5; --sage:#8fa89a; --gold:#c9a96e;
    --text:#3d2630; --shadow:rgba(61,38,48,0.12);
  }
  *{margin:0;padding:0;box-sizing:border-box;}
  body{font-family:'Noto Serif JP',serif;background:var(--cream);color:var(--text);min-height:100vh;overflow-x:hidden;}
  body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse at 20% 10%,rgba(212,144,138,.15) 0%,transparent 50%),radial-gradient(ellipse at 80% 80%,rgba(143,168,154,.12) 0%,transparent 50%);pointer-events:none;z-index:0;}
  .app-shell{max-width:390px;margin:0 auto;min-height:100vh;position:relative;z-index:1;display:flex;flex-direction:column;}
  .status-bar{display:flex;justify-content:space-between;align-items:center;padding:12px 20px 8px;font-size:11px;color:var(--mauve);font-family:'Cormorant Garamond',serif;letter-spacing:.05em;}
  .header{padding:8px 24px 16px;text-align:center;}
  .couple-badge{display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:4px;}
  .avatar{width:32px;height:32px;border-radius:50%;border:2px solid var(--dusty-rose);display:flex;align-items:center;justify-content:center;font-size:14px;background:white;box-shadow:0 2px 8px var(--shadow);}
  .heart-divider{font-size:16px;color:var(--dusty-rose);animation:heartbeat 2s ease-in-out infinite;}
  @keyframes heartbeat{0%,100%{transform:scale(1)}50%{transform:scale(1.2)}}
  .app-title{font-family:'Cormorant Garamond',serif;font-size:26px;font-weight:300;color:var(--deep);letter-spacing:.08em;font-style:italic;}
  .app-subtitle{font-size:10px;color:var(--dusty-rose);letter-spacing:.2em;text-transform:uppercase;margin-top:2px;}

  .anniversary-banner{margin:0 16px 16px;background:linear-gradient(135deg,var(--deep) 0%,var(--mauve) 100%);border-radius:16px;padding:14px 18px;display:flex;align-items:center;gap:14px;box-shadow:0 4px 20px rgba(61,38,48,.25);position:relative;overflow:hidden;}
  .anniversary-banner::before{content:'â™¡';position:absolute;right:-10px;top:-15px;font-size:80px;color:rgba(255,255,255,.05);pointer-events:none;}
  .ann-icon{font-size:28px;flex-shrink:0;}
  .ann-text h3{font-family:'Cormorant Garamond',serif;font-size:14px;font-weight:500;color:rgba(255,255,255,.9);letter-spacing:.05em;}
  .ann-text p{font-size:11px;color:rgba(255,255,255,.6);margin-top:2px;letter-spacing:.08em;}
  .ann-days{margin-left:auto;text-align:center;flex-shrink:0;}
  .ann-days .num{font-family:'Cormorant Garamond',serif;font-size:28px;font-weight:300;color:var(--gold);line-height:1;}
  .ann-days .label{font-size:9px;color:rgba(255,255,255,.5);letter-spacing:.1em;text-transform:uppercase;}

  .section{padding:0 16px;margin-bottom:16px;}
  .section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;padding:0 4px;}
  .section-title{font-family:'Cormorant Garamond',serif;font-size:18px;font-weight:500;color:var(--deep);letter-spacing:.05em;}
  .month-nav{display:flex;align-items:center;gap:8px;}
  .nav-btn{width:28px;height:28px;border:1px solid rgba(212,144,138,.4);background:white;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:12px;color:var(--dusty-rose);transition:all .2s;}
  .nav-btn:hover{background:var(--dusty-rose);color:white;border-color:var(--dusty-rose);}
  .month-label{font-family:'Cormorant Garamond',serif;font-size:14px;color:var(--mauve);letter-spacing:.08em;min-width:80px;text-align:center;}

  .calendar-card{background:white;border-radius:20px;padding:16px;box-shadow:0 2px 20px var(--shadow);}
  .day-headers{display:grid;grid-template-columns:repeat(7,1fr);margin-bottom:8px;}
  .day-header{text-align:center;font-size:10px;color:var(--mauve);letter-spacing:.08em;padding:4px 0;}
  .day-header.weekend{color:var(--dusty-rose);}
  .calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;}
  .cal-day{aspect-ratio:1;display:flex;flex-direction:column;align-items:center;justify-content:center;border-radius:10px;cursor:pointer;transition:all .2s;position:relative;padding:2px;}
  .cal-day:not(.empty):hover{background:var(--blush);}
  .cal-day.empty{cursor:default;}
  .cal-day.today{background:var(--deep);}
  .cal-day.today .day-num{color:white;}
  .cal-day.selected:not(.today){background:var(--dusty-rose);}
  .cal-day.selected:not(.today) .day-num{color:white;}
  .cal-day.anniversary:not(.today):not(.selected){background:linear-gradient(135deg,rgba(212,144,138,.15),rgba(201,169,110,.15));border:1px solid rgba(212,144,138,.3);}
  .day-num{font-size:13px;font-family:'Cormorant Garamond',serif;font-weight:500;color:var(--text);line-height:1;}
  .cal-day.other-month .day-num{color:rgba(61,38,48,.2);}
  .cal-day.weekend:not(.today):not(.selected) .day-num{color:var(--dusty-rose);}
  .event-dots{display:flex;gap:2px;margin-top:2px;flex-wrap:wrap;justify-content:center;max-width:28px;}
  .dot{width:4px;height:4px;border-radius:50%;}
  .tap-hint{font-size:10px;color:var(--mauve);opacity:.6;text-align:center;margin-top:8px;letter-spacing:.05em;font-style:italic;}

  .events-card{background:white;border-radius:20px;padding:16px;box-shadow:0 2px 20px var(--shadow);}
  .events-date-header{font-family:'Cormorant Garamond',serif;font-size:15px;font-style:italic;color:var(--mauve);margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid rgba(212,144,138,.2);display:flex;align-items:center;justify-content:space-between;}
  .add-inline-btn{font-size:11px;padding:4px 12px;border-radius:20px;border:1px solid rgba(212,144,138,.4);background:white;color:var(--dusty-rose);cursor:pointer;font-family:'Noto Serif JP',serif;transition:all .2s;letter-spacing:.02em;}
  .add-inline-btn:hover{background:var(--dusty-rose);color:white;}
  .event-item{display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid rgba(61,38,48,.05);cursor:pointer;transition:all .2s;}
  .event-item:last-child{border-bottom:none;}
  .event-item:hover{transform:translateX(4px);}
  .event-color-bar{width:4px;height:40px;border-radius:2px;flex-shrink:0;}
  .event-info{flex:1;}
  .event-title-text{font-size:13px;font-weight:600;color:var(--deep);margin-bottom:2px;}
  .event-meta{font-size:11px;color:var(--mauve);opacity:.7;display:flex;gap:8px;align-items:center;}
  .repeat-badge{font-size:9px;padding:1px 6px;border-radius:8px;background:rgba(201,169,110,.15);color:var(--gold);}
  .event-who-badge{font-size:11px;padding:3px 8px;border-radius:20px;font-family:'Cormorant Garamond',serif;letter-spacing:.05em;white-space:nowrap;}

  .memo-card{background:white;border-radius:20px;padding:16px;box-shadow:0 2px 20px var(--shadow);}
  .memo-input-area{width:100%;border:none;outline:none;font-family:'Noto Serif JP',serif;font-size:13px;color:var(--text);resize:none;background:transparent;line-height:1.8;min-height:70px;}
  .memo-input-area::placeholder{color:rgba(61,38,48,.3);font-style:italic;}
  .memo-footer{display:flex;justify-content:space-between;align-items:center;margin-top:8px;padding-top:8px;border-top:1px solid rgba(212,144,138,.2);}
  .memo-tags{display:flex;gap:6px;flex-wrap:wrap;}
  .memo-tag{font-size:10px;padding:3px 10px;border-radius:20px;border:1px solid rgba(212,144,138,.35);color:var(--dusty-rose);cursor:pointer;transition:all .2s;letter-spacing:.05em;}
  .memo-tag:hover,.memo-tag.active{background:var(--dusty-rose);color:white;border-color:var(--dusty-rose);}
  .send-btn{width:32px;height:32px;background:var(--deep);border:none;border-radius:50%;color:white;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;transition:all .2s;}
  .send-btn:hover{background:var(--dusty-rose);transform:scale(1.1);}

  .fab{position:fixed;bottom:90px;right:calc(50% - 195px + 16px);width:52px;height:52px;background:linear-gradient(135deg,var(--dusty-rose),var(--mauve));border:none;border-radius:50%;color:white;font-size:22px;cursor:pointer;box-shadow:0 4px 20px rgba(212,144,138,.5);transition:all .3s;display:flex;align-items:center;justify-content:center;z-index:100;}
  .fab:hover{transform:scale(1.1) rotate(45deg);box-shadow:0 6px 28px rgba(212,144,138,.6);}

  .bottom-nav{position:sticky;bottom:0;background:rgba(253,248,245,.95);backdrop-filter:blur(12px);border-top:1px solid rgba(212,144,138,.15);display:flex;justify-content:space-around;padding:10px 0 20px;margin-top:auto;}
  .nav-item{display:flex;flex-direction:column;align-items:center;gap:4px;cursor:pointer;padding:4px 16px;border-radius:12px;transition:all .2s;}
  .nav-item.active .nav-icon{color:var(--dusty-rose);}
  .nav-item.active .nav-label{color:var(--dusty-rose);}
  .nav-icon{font-size:20px;color:rgba(61,38,48,.3);transition:all .2s;}
  .nav-label{font-size:9px;color:rgba(61,38,48,.3);letter-spacing:.1em;text-transform:uppercase;transition:all .2s;}

  /* ======= MODAL ======= */
  .modal-overlay{position:fixed;inset:0;background:rgba(61,38,48,.5);backdrop-filter:blur(4px);z-index:200;display:none;align-items:flex-end;justify-content:center;}
  .modal-overlay.open{display:flex;}
  .modal{background:var(--cream);border-radius:24px 24px 0 0;padding:20px 20px 40px;width:100%;max-width:390px;animation:slideUp .3s ease;max-height:92vh;overflow-y:auto;}
  @keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
  .modal-handle{width:36px;height:4px;background:rgba(61,38,48,.15);border-radius:2px;margin:0 auto 16px;}
  .modal-title{font-family:'Cormorant Garamond',serif;font-size:22px;font-weight:500;color:var(--deep);margin-bottom:18px;letter-spacing:.05em;}
  .form-group{margin-bottom:14px;}
  .form-label{font-size:10px;letter-spacing:.15em;text-transform:uppercase;color:var(--mauve);margin-bottom:6px;display:block;}
  .form-input{width:100%;border:1px solid rgba(212,144,138,.3);background:white;border-radius:12px;padding:11px 14px;font-family:'Noto Serif JP',serif;font-size:14px;color:var(--text);outline:none;transition:border-color .2s;}
  .form-input:focus{border-color:var(--dusty-rose);}

  .who-selector{display:flex;gap:8px;}
  .who-btn{flex:1;padding:9px 4px;border:1px solid rgba(212,144,138,.3);background:white;border-radius:12px;cursor:pointer;font-family:'Noto Serif JP',serif;font-size:12px;color:var(--text);transition:all .2s;text-align:center;}
  .who-btn.active{background:var(--dusty-rose);color:white;border-color:var(--dusty-rose);}

  /* Color swatches */
  .color-picker-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
  .color-swatch{width:28px;height:28px;border-radius:50%;cursor:pointer;transition:all .2s;border:3px solid transparent;flex-shrink:0;}
  .color-swatch.selected{border-color:var(--deep);transform:scale(1.2);}
  .color-custom-wrap{position:relative;width:28px;height:28px;flex-shrink:0;}
  .color-custom-btn{width:28px;height:28px;border-radius:50%;cursor:pointer;border:2px dashed rgba(61,38,48,.3);background:white;display:flex;align-items:center;justify-content:center;font-size:13px;overflow:hidden;transition:all .2s;}
  .color-custom-btn:hover{border-color:var(--dusty-rose);}
  .color-custom-input{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;}

  /* Time */
  .time-row{display:flex;gap:8px;align-items:center;}
  .allday-toggle{padding:9px 14px;border:1px solid rgba(212,144,138,.3);background:white;border-radius:12px;cursor:pointer;font-family:'Noto Serif JP',serif;font-size:12px;color:var(--text);transition:all .2s;white-space:nowrap;}
  .allday-toggle.off{background:rgba(212,144,138,.12);border-color:var(--dusty-rose);color:var(--dusty-rose);}

  /* Repeat */
  .repeat-row{display:flex;gap:6px;flex-wrap:wrap;}
  .repeat-btn{padding:7px 12px;border:1px solid rgba(212,144,138,.3);background:white;border-radius:20px;cursor:pointer;font-family:'Noto Serif JP',serif;font-size:11px;color:var(--text);transition:all .2s;}
  .repeat-btn.active{background:var(--gold);color:white;border-color:var(--gold);}

  .submit-btn{width:100%;background:linear-gradient(135deg,var(--dusty-rose),var(--mauve));color:white;border:none;border-radius:14px;padding:14px;font-family:'Cormorant Garamond',serif;font-size:16px;letter-spacing:.1em;cursor:pointer;margin-top:6px;transition:all .2s;}
  .submit-btn:hover{opacity:.9;transform:translateY(-1px);box-shadow:0 4px 16px rgba(212,144,138,.4);}

  .spacer{height:80px;}
  .toast{position:fixed;top:60px;left:50%;transform:translateX(-50%) translateY(-20px);background:var(--deep);color:white;padding:10px 20px;border-radius:20px;font-size:12px;letter-spacing:.05em;opacity:0;transition:all .3s;z-index:300;pointer-events:none;white-space:nowrap;}
  .toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
</style>
</head>
<body>
<div class="app-shell">
  <div class="status-bar">
    <span id="current-time">9:41</span>
    <span style="font-style:italic;">ãµãŸã‚Šã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</span>
    <span>â—â—â—</span>
  </div>
  <div class="header">
    <div class="couple-badge">
      <div class="avatar">ğŸ§‘</div>
      <div class="heart-divider">â™¡</div>
      <div class="avatar">ğŸ‘©</div>
    </div>
    <div class="app-title">Futari</div>
    <div class="app-subtitle">äºŒäººã®æ™‚é–“ã‚’ã€ã“ã“ã«</div>
  </div>

  <div class="anniversary-banner">
    <div class="ann-icon">ğŸŒ¹</div>
    <div class="ann-text"><h3>è¨˜å¿µæ—¥ã¾ã§ã‚ã¨</h3><p>Anniversary Â· 2æœˆ14æ—¥</p></div>
    <div class="ann-days"><div class="num" id="days-count">0</div><div class="label">days</div></div>
  </div>

  <div class="section">
    <div class="section-header">
      <div class="section-title">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</div>
      <div class="month-nav">
        <button class="nav-btn" onclick="changeMonth(-1)">â€¹</button>
        <div class="month-label" id="month-label"></div>
        <button class="nav-btn" onclick="changeMonth(1)">â€º</button>
      </div>
    </div>
    <div class="calendar-card">
      <div class="day-headers">
        <div class="day-header weekend">æ—¥</div>
        <div class="day-header">æœˆ</div><div class="day-header">ç«</div>
        <div class="day-header">æ°´</div><div class="day-header">æœ¨</div>
        <div class="day-header">é‡‘</div>
        <div class="day-header weekend">åœŸ</div>
      </div>
      <div class="calendar-grid" id="calendar-grid"></div>
      <div class="tap-hint">âœ¦ æ—¥ä»˜ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨äºˆå®šç¢ºèªï¼†è¿½åŠ ã§ãã¾ã™</div>
    </div>
  </div>

  <div class="section">
    <div class="events-card">
      <div class="events-date-header">
        <span id="events-date-header">ä»Šæ—¥ã®äºˆå®š</span>
        <button class="add-inline-btn" onclick="openModal()">ï¼‹ è¿½åŠ </button>
      </div>
      <div id="events-list"></div>
    </div>
  </div>

  <div class="section">
    <div class="section-header"><div class="section-title">ãµãŸã‚Šã®ãƒ¡ãƒ¢</div></div>
    <div class="memo-card">
      <textarea class="memo-input-area" placeholder="å½¼å¥³ã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€è¡ŒããŸã„å ´æ‰€ã€ã‚„ã‚ŠãŸã„ã“ã¨â€¦" id="memo-text" rows="3"></textarea>
      <div class="memo-footer">
        <div class="memo-tags">
          <span class="memo-tag" onclick="toggleTag(this)">è¡ŒããŸã„å ´æ‰€</span>
          <span class="memo-tag" onclick="toggleTag(this)">ã‚„ã‚ŠãŸã„ã“ã¨</span>
          <span class="memo-tag" onclick="toggleTag(this)">ã»ã—ã„ã‚‚ã®</span>
        </div>
        <button class="send-btn" onclick="saveMemo()">â†’</button>
      </div>
    </div>
  </div>

  <div class="spacer"></div>
  <div class="bottom-nav">
    <div class="nav-item active"><div class="nav-icon">ğŸ—“</div><div class="nav-label">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</div></div>
    <div class="nav-item"><div class="nav-icon">ğŸŒ¹</div><div class="nav-label">è¨˜å¿µæ—¥</div></div>
    <div class="nav-item"><div class="nav-icon">ğŸ“</div><div class="nav-label">ãƒ¡ãƒ¢</div></div>
    <div class="nav-item"><div class="nav-icon">ğŸ‘«</div><div class="nav-label">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</div></div>
  </div>
</div>

<button class="fab" onclick="openModal()">ï¼‹</button>

<!-- ===== MODAL ===== -->
<div class="modal-overlay" id="modal" onclick="closeOverlay(event)">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">æ–°ã—ã„äºˆå®šã‚’è¿½åŠ </div>

    <div class="form-group">
      <label class="form-label">ã‚¿ã‚¤ãƒˆãƒ«</label>
      <input class="form-input" id="ev-title" placeholder="ä¾‹ï¼šæ˜ ç”»ãƒ‡ãƒ¼ãƒˆ ğŸ¬">
    </div>

    <div class="form-group">
      <label class="form-label">æ—¥ä»˜</label>
      <input class="form-input" type="date" id="ev-date">
    </div>

    <div class="form-group">
      <label class="form-label">æ™‚é–“</label>
      <div class="time-row">
        <button class="allday-toggle" id="allday-btn" onclick="toggleAllDay()">çµ‚æ—¥</button>
        <input class="form-input" type="time" id="ev-time" style="display:none;flex:1;" placeholder="é–‹å§‹">
        <input class="form-input" type="time" id="ev-time-end" style="display:none;flex:1;" placeholder="çµ‚äº†">
      </div>
    </div>

    <div class="form-group">
      <label class="form-label">èª°ã®äºˆå®šï¼Ÿ</label>
      <div class="who-selector">
        <button class="who-btn" id="btn-mine" onclick="selectWho('mine')">ğŸ§‘ è‡ªåˆ†</button>
        <button class="who-btn" id="btn-hers" onclick="selectWho('hers')">ğŸ‘© å½¼å¥³</button>
        <button class="who-btn active" id="btn-shared" onclick="selectWho('shared')">ğŸ’‘ ãµãŸã‚Š</button>
      </div>
    </div>

    <div class="form-group">
      <label class="form-label">è‰²ã§åŒºåˆ¥</label>
      <div class="color-picker-row" id="color-picker"></div>
    </div>

    <div class="form-group">
      <label class="form-label">ç¹°ã‚Šè¿”ã—</label>
      <div class="repeat-row">
        <button class="repeat-btn active" onclick="selectRepeat(this,'none')">ãªã—</button>
        <button class="repeat-btn" onclick="selectRepeat(this,'daily')">æ¯æ—¥</button>
        <button class="repeat-btn" onclick="selectRepeat(this,'weekly')">æ¯é€±</button>
        <button class="repeat-btn" onclick="selectRepeat(this,'monthly')">æ¯æœˆ</button>
        <button class="repeat-btn" onclick="selectRepeat(this,'yearly')">æ¯å¹´</button>
      </div>
    </div>

    <div class="form-group">
      <label class="form-label">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
      <input class="form-input" id="ev-note" placeholder="å ´æ‰€ã‚„è©³ç´°ãªã©â€¦">
    </div>

    <button class="submit-btn" onclick="addEvent()">äºˆå®šã‚’è¿½åŠ ã™ã‚‹</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const PALETTE = ['#d4908a','#9e6b72','#8fa89a','#c9a96e','#7b9eb3','#a89ac9','#b5c98a','#e8a87c'];
let selColor = PALETTE[3];
let selWho = 'shared';
let selRepeat = 'none';
let isAllDay = true;
let curY = new Date().getFullYear();
let curM = new Date().getMonth();
let selDate = null;
let nextId = 10;

const T = new Date();
const TY=T.getFullYear(), TM=T.getMonth(), TD=T.getDate();

function fmtD(y,m,d){
  const dt=new Date(y,m,d);
  return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')}`;
}

let events=[
  {id:1,date:fmtD(TY,TM,TD),title:'æ˜ ç”»ãƒ‡ãƒ¼ãƒˆ ğŸ¬',who:'shared',color:'#c9a96e',time:'15:00',repeat:'none'},
  {id:2,date:fmtD(TY,TM,TD+2),title:'å½¼å¥³ã®èª•ç”Ÿæ—¥ãƒ‡ã‚£ãƒŠãƒ¼ ğŸ‚',who:'shared',color:'#d4908a',time:'19:00',repeat:'none'},
  {id:3,date:fmtD(TY,TM,TD+5),title:'æ­¯åŒ»è€…',who:'mine',color:'#7b9eb3',time:'14:30',repeat:'none'},
  {id:4,date:fmtD(TY,1,14),title:'ãƒãƒ¬ãƒ³ã‚¿ã‚¤ãƒ³ãƒ‡ãƒ¼ ğŸ’•',who:'shared',color:'#d4908a',time:'',repeat:'yearly'},
];

function getEventsForDate(ds){
  return events.filter(ev=>{
    if(ev.date===ds)return true;
    if(ev.repeat==='none')return false;
    const[ey,em,ed]=ev.date.split('-').map(Number);
    const[ty,tm,td]=ds.split('-').map(Number);
    if(ev.repeat==='daily')return ds>=ev.date;
    if(ev.repeat==='weekly'){
      const o=new Date(ey,em-1,ed),t2=new Date(ty,tm-1,td);
      const d=(t2-o)/86400000;
      return d>=0&&d%7===0;
    }
    if(ev.repeat==='monthly')return em===tm&&ed===td&&ds>=ev.date;
    if(ev.repeat==='yearly')return em===tm&&ed===td;
    return false;
  });
}

function repeatLabel(r){return{none:'',daily:'æ¯æ—¥',weekly:'æ¯é€±',monthly:'æ¯æœˆ',yearly:'æ¯å¹´'}[r]||'';}

function showToast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2500);
}

function updateClock(){
  const n=new Date();
  document.getElementById('current-time').textContent=`${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}`;
}
setInterval(updateClock,1000);updateClock();

function updateCountdown(){
  const now=new Date();
  let next=new Date(now.getFullYear(),1,14);
  if(next<=now)next.setFullYear(next.getFullYear()+1);
  const diff=Math.ceil((next-now)/86400000);
  document.getElementById('days-count').textContent=diff===0?'ä»Šæ—¥ï¼':diff;
}

function changeMonth(dir){
  curM+=dir;
  if(curM>11){curM=0;curY++;}
  if(curM<0){curM=11;curY--;}
  renderCalendar();
}

function renderCalendar(){
  const months=['1æœˆ','2æœˆ','3æœˆ','4æœˆ','5æœˆ','6æœˆ','7æœˆ','8æœˆ','9æœˆ','10æœˆ','11æœˆ','12æœˆ'];
  document.getElementById('month-label').textContent=`${curY}å¹´ ${months[curM]}`;
  const grid=document.getElementById('calendar-grid');
  grid.innerHTML='';
  const first=new Date(curY,curM,1).getDay();
  const dim=new Date(curY,curM+1,0).getDate();
  const prev=new Date(curY,curM,0).getDate();

  for(let i=first-1;i>=0;i--){
    grid.appendChild(makeEmpty(prev-i));
  }

  for(let d=1;d<=dim;d++){
    const ds=fmtD(curY,curM,d);
    const isToday=d===TD&&curM===TM&&curY===TY;
    const isSel=selDate===ds;
    const isWE=[0,6].includes(new Date(curY,curM,d).getDay());
    const isAnn=curM===1&&d===14;
    const evs=getEventsForDate(ds);

    const cell=document.createElement('div');
    let cls='cal-day';
    if(isToday)cls+=' today';
    if(isSel)cls+=' selected';
    if(isWE)cls+=' weekend';
    if(isAnn)cls+=' anniversary';
    cell.className=cls;

    const num=document.createElement('div');
    num.className='day-num';num.textContent=d;
    cell.appendChild(num);

    if(evs.length){
      const dots=document.createElement('div');
      dots.className='event-dots';
      evs.slice(0,3).forEach(ev=>{
        const dot=document.createElement('div');
        dot.className='dot';
        dot.style.background=ev.color||'#d4908a';
        dots.appendChild(dot);
      });
      cell.appendChild(dots);
    }
    cell.onclick=()=>selectDate(ds,d);
    grid.appendChild(cell);
  }

  const total=first+dim;
  const rem=total%7===0?0:7-(total%7);
  for(let d=1;d<=rem;d++)grid.appendChild(makeEmpty(d));
}

function makeEmpty(d){
  const c=document.createElement('div');
  c.className='cal-day empty other-month';
  const n=document.createElement('div');
  n.className='day-num';n.textContent=d;
  c.appendChild(n);return c;
}

function selectDate(ds,d){
  selDate=ds;
  // â˜… æ—¥ä»˜ã‚¿ãƒƒãƒ—ã§è‡ªå‹•å…¥åŠ›
  document.getElementById('ev-date').value=ds;
  renderCalendar();
  renderEvents(ds,d);
}

function renderEvents(ds,d){
  const months=['1æœˆ','2æœˆ','3æœˆ','4æœˆ','5æœˆ','6æœˆ','7æœˆ','8æœˆ','9æœˆ','10æœˆ','11æœˆ','12æœˆ'];
  const hdr=document.getElementById('events-date-header');
  const list=document.getElementById('events-list');

  if(ds){
    const[y,m,day]=ds.split('-').map(Number);
    hdr.textContent=`${y}å¹´${months[m-1]}${day}æ—¥`;
  } else {
    hdr.textContent='ä»Šæ—¥ã®äºˆå®š';
    ds=fmtD(TY,TM,TD);
  }

  const evs=getEventsForDate(ds);
  list.innerHTML='';

  if(!evs.length){
    list.innerHTML=`<div style="text-align:center;padding:20px;color:rgba(61,38,48,.3);font-style:italic;font-size:13px;">ã“ã®æ—¥ã¯äºˆå®šãªã— â˜ï¸</div>`;
    return;
  }

  const whoL={mine:'è‡ªåˆ†',hers:'å½¼å¥³',shared:'ãµãŸã‚Š'};
  evs.forEach(ev=>{
    const item=document.createElement('div');
    item.className='event-item';
    const rl=repeatLabel(ev.repeat);
    item.innerHTML=`
      <div class="event-color-bar" style="background:${ev.color}"></div>
      <div class="event-info">
        <div class="event-title-text">${ev.title}</div>
        <div class="event-meta">
          ${ev.time?`<span>ğŸ• ${ev.time}</span>`:'<span>çµ‚æ—¥</span>'}
          ${rl?`<span class="repeat-badge">ğŸ” ${rl}</span>`:''}
        </div>
      </div>
      <span class="event-who-badge" style="background:${ev.color}22;color:${ev.color}">${whoL[ev.who]||''}</span>
    `;
    list.appendChild(item);
  });
}

// ===== MODAL =====
function openModal(){
  document.getElementById('ev-date').value=selDate||fmtD(TY,TM,TD);
  document.getElementById('modal').classList.add('open');
}
function closeOverlay(e){if(e.target.id==='modal')document.getElementById('modal').classList.remove('open');}

function selectWho(who){
  selWho=who;
  ['mine','hers','shared'].forEach(w=>document.getElementById(`btn-${w}`).classList.toggle('active',w===who));
}

function toggleAllDay(){
  isAllDay=!isAllDay;
  const btn=document.getElementById('allday-btn');
  const t=document.getElementById('ev-time');
  const te=document.getElementById('ev-time-end');
  btn.textContent=isAllDay?'çµ‚æ—¥':'æ™‚é–“ã‚ã‚Š';
  btn.classList.toggle('off',!isAllDay);
  t.style.display=isAllDay?'none':'block';
  te.style.display=isAllDay?'none':'block';
}

function buildColorPicker(){
  const row=document.getElementById('color-picker');
  row.innerHTML='';
  PALETTE.forEach(c=>{
    const sw=document.createElement('div');
    sw.className='color-swatch'+(c===selColor?' selected':'');
    sw.style.background=c;
    sw.onclick=()=>{
      selColor=c;
      row.querySelectorAll('.color-swatch').forEach(s=>s.classList.remove('selected'));
      sw.classList.add('selected');
    };
    row.appendChild(sw);
  });
  // ã‚«ã‚¹ã‚¿ãƒ è‰²ãƒœã‚¿ãƒ³
  const wrap=document.createElement('div');
  wrap.className='color-custom-wrap';
  wrap.innerHTML=`<div class="color-custom-btn" title="ã‚«ã‚¹ã‚¿ãƒ ">ï¼‹</div><input type="color" class="color-custom-input" onchange="pickCustom(this)">`;
  row.appendChild(wrap);
}

function pickCustom(input){
  selColor=input.value;
  const row=document.getElementById('color-picker');
  row.querySelectorAll('.color-swatch').forEach(s=>s.classList.remove('selected'));
  const btn=input.previousElementSibling;
  btn.style.background=input.value;
  btn.textContent='';
}

function selectRepeat(btn,val){
  selRepeat=val;
  document.querySelectorAll('.repeat-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
}

function addEvent(){
  const title=document.getElementById('ev-title').value.trim();
  const date=document.getElementById('ev-date').value;
  if(!title||!date){showToast('ã‚¿ã‚¤ãƒˆãƒ«ã¨æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
  const time=isAllDay?'':(document.getElementById('ev-time').value||'');
  const note=document.getElementById('ev-note').value.trim();

  events.push({id:nextId++,date,title,who:selWho,color:selColor,time,note,repeat:selRepeat});
  document.getElementById('modal').classList.remove('open');
  document.getElementById('ev-title').value='';
  document.getElementById('ev-note').value='';

  renderCalendar();
  const[y,m,d]=date.split('-').map(Number);
  renderEvents(date,d);

  const rl=selRepeat!=='none'?`ï¼ˆ${repeatLabel(selRepeat)}ï¼‰`:'';
  showToast(`âœ“ äºˆå®šã‚’è¿½åŠ ã—ã¾ã—ãŸ${rl}`);
}

function toggleTag(el){el.classList.toggle('active');}
function saveMemo(){
  const text=document.getElementById('memo-text').value.trim();
  if(!text){showToast('ãƒ¡ãƒ¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
  document.getElementById('memo-text').value='';
  document.querySelectorAll('.memo-tag.active').forEach(t=>t.classList.remove('active'));
  showToast('ğŸ’Œ ãƒ¡ãƒ¢ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
}

document.querySelectorAll('.nav-item').forEach(item=>{
  item.addEventListener('click',function(){
    document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
    this.classList.add('active');
  });
});

buildColorPicker();
updateCountdown();
renderCalendar();
renderEvents(null,null);
</script>
</body>
</html>
